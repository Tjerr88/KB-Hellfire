<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KB Hellfire</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body.dark { background-color:#111; color:#eee; }
    .dark .bg-white { background-color:#222 !important; }
    .dark .bg-gray-100 { background-color:#333 !important; }
    .dark .bg-gray-50 { background-color:#222 !important; }
    .link-pill { display:inline-block; padding:.4rem .6rem; border-radius:.6rem; border:1px solid rgba(0,0,0,.1); }
    .dark .link-pill { border-color: rgba(255,255,255,.15); }
  </style>
</head>
<body class="bg-gray-100">
  <div id="root" class="p-2 sm:p-4"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const patternColors = {
      squat: "text-blue-400",
      hinge: "text-purple-400",
      push: "text-red-400",
      pull: "text-green-400",
      core: "text-yellow-400",
      hybrid: "text-orange-400"
    };

    // âœ… Test Workout with links
    const testWorkout = [
      { name: "Two-arm Swing", reps: 30, pattern: "hinge", unilateral: false, video: "https://www.youtube.com/watch?v=1cVT3ee9mgU" },
      { name: "Deadlift", reps: 25, pattern: "hinge", unilateral: false, video: "https://www.youtube.com/watch?v=l6gDwf3xC6s" },
      { name: "Snatch", reps: 50, pattern: "pull", unilateral: true, video: "https://www.youtube.com/watch?v=QsuJ6973OFc" },
      { name: "Goblet Squat", reps: 35, pattern: "squat", unilateral: false, video: "https://www.youtube.com/shorts/dBnNCOtuGNQ" },
      { name: "One-arm Swing", reps: 60, pattern: "hinge", unilateral: true, video: "https://www.youtube.com/watch?v=UYBKrK1y6ww" },
      { name: "Russian Twist", reps: 40, pattern: "core", unilateral: false, video: "https://www.youtube.com/watch?v=7XUglHKRyMo" },
      { name: "Clean & Press", reps: 30, pattern: "hybrid", unilateral: true, video: "https://www.youtube.com/watch?v=km3f8_rpDdg" },
      { name: "Two-arm Swing", reps: 30, pattern: "hinge", unilateral: false, video: "https://www.youtube.com/watch?v=1cVT3ee9mgU" }
    ];

    // ðŸ“š Exercise database (same content, English comments)
    const exerciseDatabase = {
      beginner: {
        squat: [
          { name: "Goblet Squat", type: "Grind", stimulus: 1.3, unilateral: false, video: "https://www.youtube.com/shorts/dBnNCOtuGNQ" },
          { name: "Single Side Front Squat", type: "Grind", stimulus: 1.3, unilateral: true, video: "https://www.youtube.com/watch?v=SlPwjU6I9gk" },
          { name: "Jump Squat", type: "Ballistic", stimulus: 1.8, unilateral: false, video: "https://www.youtube.com/watch?v=v3prQwHewL0" }
        ],
        hinge: [
          { name: "Deadlift (sumo/standard)", type: "Grind", stimulus: 0.8, unilateral: false, video: "https://www.youtube.com/watch?v=xFU5zTZgiyE" },
          { name: "B-stance Deadlift", type: "Grind", stimulus: 1.1, unilateral: true, video: "https://www.youtube.com/shorts/8-mW9b4WbRo" },
          { name: "Two-arm Swing", type: "Ballistic", stimulus: 1.1, unilateral: false, video: "https://www.youtube.com/watch?v=1cVT3ee9mgU" },
          { name: "Glute Bridge", type: "Grind", stimulus: 1.0, unilateral: false, video: "https://www.youtube.com/shorts/ULl7xM2yWgo" }
        ],
        push: [
          { name: "Floor Press", type: "Grind", stimulus: 1.2, unilateral: true, video: "https://www.youtube.com/shorts/1QMCUbRkQFA" },
          { name: "Half-Kneeling Press", type: "Grind", stimulus: 1.4, unilateral: true, video: "https://www.youtube.com/shorts/n0peUzKZ-PU" },
          { name: "Push Press", type: "Ballistic", stimulus: 1.3, unilateral: true, video: "https://www.youtube.com/watch?v=CCqru4q9RK0" },
          { name: "Military Press", type: "Grind", stimulus: 1.6, unilateral: true, video: "https://www.youtube.com/shorts/oYubnI4aXD8" }
        ],
        pull: [
          { name: "Bent-over Row", type: "Grind", stimulus: 1.4, unilateral: true, video: "https://www.youtube.com/shorts/pvRXtyBkO-s" },
          { name: "Pull-over", type: "Grind", stimulus: 1.2, unilateral: false, video: "https://www.youtube.com/shorts/HEV0UZIlEag" },
          { name: "Clean", type: "Ballistic", stimulus: 1.4, unilateral: true, video: "https://www.youtube.com/shorts/xQb9Tc3iQpI" },
          { name: "One-arm High Pull", type: "Ballistic", stimulus: 1.4, unilateral: true, video: "https://www.youtube.com/watch?v=mP1BHxBeAEM" }
        ],
        core: [
          { name: "Russian Twist", type: "Ballistic", stimulus: 0.7, unilateral: false, video: "https://www.youtube.com/watch?v=7XUglHKRyMo" },
          { name: "Half-Kneeling Windmill", type: "Grind", stimulus: 1.2, unilateral: true, video: "https://www.youtube.com/shorts/BfYW9PI5LS8" },
          { name: "Supine Get-up Sit-up", type: "Grind", stimulus: 1.5, unilateral: true, video: "https://www.youtube.com/watch?v=dv_nNf43Qck" },
          { name: "Front Rack Hold / Carry", type: "Grind", stimulus: 0.5, unilateral: false, video: "https://www.youtube.com/watch?v=jumVlXfY1Pc" }
        ],
        hybrid: [
          { name: "Clean & Squat", type: "Grind", stimulus: 2.5, unilateral: true, video: "https://www.youtube.com/watch?v=iSkQEUoC22Q" },
          { name: "Squat & Press", type: "Ballistic", stimulus: 2.0, unilateral: false, video: "https://www.youtube.com/watch?v=7E0o5Hv8TMk" },
          { name: "Clean & Press", type: "Grind", stimulus: 2.0, unilateral: true, video: "https://www.youtube.com/watch?v=km3f8_rpDdg" },
          { name: "Clean & Push Press", type: "Ballistic", stimulus: 2.0, unilateral: true, video: "https://www.youtube.com/shorts/HWHJW0ivos8" }
        ]
      },
      advanced: {
        squat: [
          { name: "Side Lunge / Cossack", type: "Grind", stimulus: 1.5, unilateral: true, video: "https://www.youtube.com/watch?v=WG1a97zsGdw" },
          { name: "Bulgarian Split Squat", type: "Grind", stimulus: 1.5, unilateral: true, video: "https://www.youtube.com/watch?v=JQQpO06hUvI" },
          { name: "Step-up / Pistol (with box)", type: "Grind", stimulus: 1.6, unilateral: true, video: "https://www.youtube.com/watch?v=0DbaQ490LMs" }
        ],
        hinge: [
          { name: "One-arm Swing", type: "Ballistic", stimulus: 1.2, unilateral: true, video: "https://www.youtube.com/watch?v=UYBKrK1y6ww" },
          { name: "Hand-to-Hand Swing", type: "Ballistic", stimulus: 1.4, unilateral: false, video: "https://www.youtube.com/shorts/lQqR4wzdMak" }
        ],
        push: [
          { name: "Top-Down Press", type: "Grind", stimulus: 2.2, unilateral: true, video: "https://www.youtube.com/watch?v=a9zEt8d-DYU" },
          { name: "Push Jerk / VPP", type: "Ballistic", stimulus: 1.4, unilateral: true, video: "https://www.youtube.com/shorts/5lSuYCma88w" }
        ],
        pull: [
          { name: "Renegade Row", type: "Grind", stimulus: 1.3, unilateral: true, video: "https://www.youtube.com/watch?v=7l03NoMzGp4" },
          { name: "Snatch", type: "Ballistic", stimulus: 1.6, unilateral: true, video: "https://www.youtube.com/watch?v=QsuJ6973OFc" }
        ],
        core: [
          { name: "Turkish Get-up", type: "Grind", stimulus: 3.5, unilateral: true, special: "tgu", video: "https://www.youtube.com/watch?v=sgd8n917Zv0" },
          { name: "Windmill", type: "Grind", stimulus: 1.8, unilateral: true, video: "https://www.youtube.com/shorts/EZWHnzAjctU" }
        ],
        hybrid: [
          { name: "Snatch & Press", type: "Grind", stimulus: 2.0, unilateral: true, video: "https://www.youtube.com/shorts/icAh8ZEjNx8" },
          { name: "Clean â†’ Press â†’ Squat", type: "Grind", stimulus: 2.5, unilateral: true, video: "https://www.youtube.com/watch?v=Fsd4VcFO094" }
        ]
      }
    };

    const shuffleArray = (array) => {
      const arr = [...array];
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    };

    // ðŸ” LocalStorage keys
    const LS = {
      HISTORY: "kbInfernoHistory",
      LAST_NAMES: "kbInfernoLastWorkout",
      THEME: "theme",
      ACTIVE: "kbInfernoActiveWorkout" // holds: workout, level, totalSU, testMode, time, timerRunning, startedAt, note
    };

    function App() {
      const [level, setLevel] = useState("beginner");
      const [totalSU, setTotalSU] = useState(300);
      const [testMode, setTestMode] = useState(false);
      const [workout, setWorkout] = useState([]);
      const [history, setHistory] = useState([]);
      const [expandedIndex, setExpandedIndex] = useState(null); // history expand/collapse
      const [openExercise, setOpenExercise] = useState(null);   // per-exercise dropdown
      const [darkMode, setDarkMode] = useState(false);
      const [lastWorkoutExercises, setLastWorkoutExercises] = useState([]);
      const [preCheckEnabled, setPreCheckEnabled] = useState(false);
      const [showPreCheck, setShowPreCheck] = useState(false);
      const [preCheckAnswers, setPreCheckAnswers] = useState({ sleep: false, soreness: false, energy: false });

      // Timer state
      const [timerRunning, setTimerRunning] = useState(false);
      const [time, setTime] = useState(0);
      const intervalRef = useRef(null);

      // ðŸ” INIT
      useEffect(() => {
        const savedHistory = JSON.parse(localStorage.getItem(LS.HISTORY) || "[]");
        setHistory(savedHistory);

        const theme = localStorage.getItem(LS.THEME) || "light";
        setDarkMode(theme === "dark");
        document.body.classList.toggle("dark", theme === "dark");

        const last = JSON.parse(localStorage.getItem(LS.LAST_NAMES) || "[]");
        setLastWorkoutExercises(last);

        // âª Restore active session if present
        const active = JSON.parse(localStorage.getItem(LS.ACTIVE) || "null");
        if (active && active.workout && active.workout.length) {
          setWorkout(active.workout);
          setLevel(active.level ?? "beginner");
          setTotalSU(active.totalSU ?? 300);
          setTestMode(!!active.testMode);
          setTime(active.time ?? 0);
          setTimerRunning(!!active.timerRunning);
        }
      }, []);

      // â±ï¸ Timer effect
      useEffect(() => {
        if (timerRunning) {
          if (intervalRef.current) clearInterval(intervalRef.current);
          intervalRef.current = setInterval(() => {
            setTime((prev) => prev + 1);
          }, 1000);
        } else if (intervalRef.current) {
          clearInterval(intervalRef.current);
          intervalRef.current = null;
        }
        return () => {
          if (intervalRef.current) clearInterval(intervalRef.current);
        };
      }, [timerRunning]);

      // ðŸ’¾ Persist active workout + timer state
      useEffect(() => {
        if (workout && workout.length) {
          const payload = {
            workout,
            level,
            totalSU,
            testMode,
            time,
            timerRunning,
            startedAt: Date.now()
          };
          localStorage.setItem(LS.ACTIVE, JSON.stringify(payload));
        } else {
          localStorage.removeItem(LS.ACTIVE);
        }
      }, [workout, level, totalSU, testMode, time, timerRunning]);

      const formatTime = (seconds) => {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs < 10 ? "0" : ""}${secs}`;
      };

      const startTimer = () => { setTime(0); setTimerRunning(true); };

      const stopTimer = () => {
        setTimerRunning(false);
        alert(`Workout time: ${formatTime(time)}`);
        if (history.length > 0) {
          const updatedHistory = [...history];
          updatedHistory[0].time = formatTime(time);
          if (updatedHistory[0].type === "test" && time <= 1200) {
            updatedHistory[0].note = "Bell Up! Completed test in under 20 minutes.";
            alert("Bell Up! Great job â€” move to a heavier bell next session.");
          }
          setHistory(updatedHistory);
          localStorage.setItem(LS.HISTORY, JSON.stringify(updatedHistory));
        }
      };

      // âœ… Complete session: stop timer, keep history, clear active session
      const completeSession = () => {
        if (timerRunning) {
          if (!confirm("Timer is still running. Stop and complete?")) return;
          stopTimer();
        }
        setWorkout([]);
        localStorage.removeItem(LS.ACTIVE);
        setOpenExercise(null);
        alert("Session cleared. Ready for the next workout.");
      };

      // âŒ Discard current session without touching history
      const abandonSession = () => {
        if (!workout.length) return;
        if (!confirm("Discard the current (uncompleted) session? This also removes it from memory.")) return;
        setWorkout([]);
        localStorage.removeItem(LS.ACTIVE);
        setOpenExercise(null);
      };

      const toggleDarkMode = () => {
        const newMode = !darkMode;
        setDarkMode(newMode);
        document.body.classList.toggle("dark", newMode);
        localStorage.setItem(LS.THEME, newMode ? "dark" : "light");
      };

      const handleGenerateClick = () => {
        if (preCheckEnabled) setShowPreCheck(true);
        else generateWorkout();
      };

      const handlePreCheckSubmit = () => {
        const score = Object.values(preCheckAnswers).filter(Boolean).length;
        if (score === 0) {
          alert("Recovery Day: Your body needs extra recovery today. Skip your Hellfire workout and do light mobility or stretching instead.");
          saveToHistory("recovery", []);
          setShowPreCheck(false);
          return;
        }
        if (score === 1) setTotalSU(300);
        else if (score === 2) setTotalSU(400);
        setShowPreCheck(false);
        generateWorkout(`Pre-check score: ${score}`);
      };

      const generateWorkout = (note = null) => {
        // Prevent accidental overwrite if there is an active session
        const hasActive = (workout && workout.length);
        if (hasActive && !confirm("There is an active session. Overwrite it with a new workout?")) return;

        setTimerRunning(false);
        setTime(0);
        setOpenExercise(null);

        if (testMode) {
          setWorkout(testWorkout);
          saveToHistory("test", testWorkout, note);
          localStorage.setItem(LS.LAST_NAMES, JSON.stringify(testWorkout.map(e => e.name)));
        } else {
          const db = exerciseDatabase[level];
          const patterns = Object.keys(db);
          let exercises = [];
          let currentSU = 0;
          let patternCount = {};

          // at least 1 per pattern
          patterns.forEach(pattern => {
            const options = db[pattern].filter(opt => !lastWorkoutExercises.includes(opt.name)) || db[pattern];
            const exercise = options.length ? options[Math.floor(Math.random() * options.length)] : db[pattern][0];

            const suForExercise = Math.floor(Math.random() * 41) + 30;
            const reps = Math.round(suForExercise / exercise.stimulus);

            currentSU += suForExercise;
            patternCount[pattern] = 1;

            exercises.push({
              ...exercise,
              pattern,
              reps,
              su: suForExercise,
              formattedReps: exercise.unilateral
                ? `${reps} reps (${Math.ceil(reps / 2)} per arm)`
                : `${reps} reps`
            });
          });

          // fill until target SU, max 2 per pattern
          while (currentSU < totalSU - 30) {
            const pattern = patterns[Math.floor(Math.random() * patterns.length)];
            if (patternCount[pattern] >= 2) continue;

            const options = db[pattern].filter(opt => !lastWorkoutExercises.includes(opt.name)) || db[pattern];
            const exercise = options.length ? options[Math.floor(Math.random() * options.length)] : db[pattern][0];

            const suForExercise = Math.floor(Math.random() * 41) + 30;
            if (currentSU + suForExercise > totalSU + 10) break;

            const reps = Math.round(suForExercise / exercise.stimulus);

            currentSU += suForExercise;
            patternCount[pattern] = (patternCount[pattern] || 0) + 1;

            exercises.push({
              ...exercise,
              pattern,
              reps,
              su: suForExercise,
              formattedReps: exercise.unilateral
                ? `${reps} reps (${Math.ceil(reps / 2)} per arm)`
                : `${reps} reps`
            });
          }

          const finalList = shuffleArray(exercises);
          setWorkout(finalList);
          saveToHistory("workout", finalList, note);
          localStorage.setItem(LS.LAST_NAMES, JSON.stringify(finalList.map(e => e.name)));
        }
      };

      const saveToHistory = (type, workoutData, note = null) => {
        const now = new Date();
        const entry = {
          date: now.toLocaleString(),
          type,
          level,
          totalSU,
          exercises: workoutData.map(ex => ({
            name: ex.name,
            reps: ex.reps || ex.formattedReps,
            pattern: ex.pattern,
            su: ex.su,
            unilateral: ex.unilateral,
            video: ex.video || null
          })),
          note
        };
        const updated = [entry, ...history].slice(0, 5);
        setHistory(updated);
        localStorage.setItem(LS.HISTORY, JSON.stringify(updated));
      };

      const removeLastEntry = () => {
        if (!history.length) return;
        if (!confirm("Remove last workout from history?")) return;
        const updated = history.slice(1);
        setHistory(updated);
        localStorage.setItem(LS.HISTORY, JSON.stringify(updated));
      };

      const resetAll = () => {
        if (!confirm("Clear all history and the current workout?")) return;
        setWorkout([]);
        setHistory([]);
        localStorage.removeItem(LS.HISTORY);
        localStorage.removeItem(LS.LAST_NAMES);
        localStorage.removeItem(LS.ACTIVE);
      };

      const toggleExpand = (index) => {
        setExpandedIndex(expandedIndex === index ? null : index);
      };

      return (
        <div className="max-w-2xl mx-auto bg-white shadow-md rounded-lg p-4 sm:p-6">
          <div className="flex justify-between mb-2">
            <h1 className="text-3xl font-extrabold bg-gradient-to-r from-red-600 via-orange-500 to-yellow-400 bg-clip-text text-transparent">
              KB Hellfire
            </h1>
            <div className="flex gap-2">
              <button onClick={toggleDarkMode} className="px-3 py-1 bg-gray-700 text-white rounded text-sm">
                {darkMode ? "Light Mode" : "Dark Mode"}
              </button>
              <button
                onClick={() => setPreCheckEnabled(!preCheckEnabled)}
                className={`px-3 py-1 rounded text-sm ${preCheckEnabled ? "bg-green-600 text-white" : "bg-gray-300"}`}
              >
                Pre-Check {preCheckEnabled ? "On" : "Off"}
              </button>
            </div>
          </div>
          <p className="text-center mb-4 text-lg bg-gradient-to-r from-orange-400 to-red-500 bg-clip-text text-transparent">
            One Bell to Burn Them All, One Calorie at a Time
          </p>

          {/* Tabs Normal/Test */}
          <div className="flex justify-center mb-4">
            <button
              onClick={() => { setTestMode(false); setWorkout([]); }}
              className={`flex-1 px-4 py-2 rounded-l ${!testMode ? "bg-orange-600 text-white" : "bg-gray-300"}`}
            >
              Normal Workout
            </button>
            <button
              onClick={() => { setTestMode(true); setWorkout([]); }}
              className={`flex-1 px-4 py-2 rounded-r ${testMode ? "bg-orange-600 text-white" : "bg-gray-300"}`}
            >
              Test Workout
            </button>
          </div>

          {/* Level & SU toggles */}
          {!testMode && (
            <>
              <div className="flex flex-wrap justify-center gap-2 mb-4">
                {["beginner", "advanced"].map((lvl) => (
                  <button
                    key={lvl}
                    onClick={() => setLevel(lvl)}
                    className={`px-4 py-2 rounded text-sm ${level === lvl ? "bg-orange-600 text-white" : "bg-gray-300"}`}
                  >
                    {lvl}
                  </button>
                ))}
              </div>

              <div className="flex flex-wrap justify-center gap-2 mb-6">
                {[300, 400, 500].map(val => (
                  <button
                    key={val}
                    onClick={() => setTotalSU(val)}
                    className={`px-4 py-2 rounded text-sm ${totalSU === val ? "bg-orange-600 text-white" : "bg-gray-300"}`}
                  >
                    {val} SU
                  </button>
                ))}
              </div>
            </>
          )}

          {/* Generate button */}
          <div className="text-center mb-6">
            <button
              onClick={handleGenerateClick}
              className="px-6 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg"
            >
              Generate Workout
            </button>
          </div>

          {/* Pre-Check Modal */}
          {showPreCheck && (
            <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
              <div className="bg-white p-6 rounded shadow-md max-w-md w-full">
                <h2 className="text-lg font-bold mb-4">Pre-Workout Check</h2>
                <p className="mb-3 text-sm">Select if you feel well rested, energized and have minimal soreness.</p>
                <div className="space-y-2">
                  {["sleep", "energy", "soreness"].map(key => (
                    <label key={key} className="flex items-center space-x-2">
                      <input
                        type="checkbox"
                        checked={preCheckAnswers[key]}
                        onChange={() => setPreCheckAnswers(prev => ({ ...prev, [key]: !prev[key] }))}
                      />
                      <span>{key.charAt(0).toUpperCase() + key.slice(1)}</span>
                    </label>
                  ))}
                </div>
                <div className="flex justify-end gap-2 mt-4">
                  <button onClick={() => setShowPreCheck(false)} className="px-3 py-1 bg-gray-400 text-white rounded">Cancel</button>
                  <button onClick={handlePreCheckSubmit} className="px-3 py-1 bg-orange-500 text-white rounded">Submit</button>
                </div>
              </div>
            </div>
          )}

          {/* Workout List (with dropdown for links) */}
          {workout.length > 0 && (
            <>
              <ul className="space-y-3 mt-4">
                {workout.map((exercise, index) => (
                  <li
                    key={index}
                    className={`border rounded p-3 bg-gray-50 ${patternColors[exercise.pattern] || ""}`}
                  >
                    <button
                      className="w-full text-left"
                      onClick={() => setOpenExercise(openExercise === index ? null : index)}
                    >
                      <div className="flex items-center justify-between">
                        <div className="text-lg font-semibold">
                          {index + 1}. {exercise.name}
                        </div>
                        <span className="text-sm">{openExercise === index ? "â–²" : "â–¼"}</span>
                      </div>
                    </button>

                    <div className="text-md font-bold text-gray-800 mt-1">
                      {exercise.unilateral
                        ? `${exercise.reps} reps (${Math.ceil(exercise.reps / 2)} per arm)`
                        : `${exercise.reps} reps`}
                      {!testMode && exercise.su && (
                        <span className="ml-2 text-sm text-gray-600">({exercise.su} SU)</span>
                      )}
                    </div>

                    {/* Dropdown content */}
                    {openExercise === index && (
                      <div className="mt-2">
                        {exercise.video ? (
                          <a
                            href={exercise.video}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="link-pill hover:bg-orange-50 dark:hover:bg-gray-700"
                            title="Watch demo"
                          >
                            â–¶ï¸Ž Watch demo (YouTube)
                          </a>
                        ) : (
                          <span className="text-sm italic text-gray-500">No video link available</span>
                        )}
                      </div>
                    )}
                  </li>
                ))}
              </ul>

              {/* Timer + Session controls */}
              <div className="text-center mt-4 space-x-2">
                {!timerRunning && (
                  <button onClick={startTimer} className="px-4 py-2 bg-green-600 text-white rounded">
                    Start Timer
                  </button>
                )}
                {timerRunning && (
                  <div className="inline-flex items-center gap-3">
                    <div className="text-xl font-bold my-2">{formatTime(time)}</div>
                    <button onClick={stopTimer} className="px-4 py-2 bg-red-600 text-white rounded">
                      Stop Timer
                    </button>
                  </div>
                )}
                {!timerRunning && time > 0 && (
                  <span className="inline-block text-sm align-middle ml-2">{formatTime(time)}</span>
                )}
              </div>

              <div className="flex justify-center gap-2 mt-3">
                <button onClick={completeSession} className="px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded">
                  Complete (save & clear)
                </button>
                <button onClick={abandonSession} className="px-4 py-2 bg-gray-400 hover:bg-gray-500 text-white rounded">
                  Discard current
                </button>
              </div>
            </>
          )}

          {/* History */}
          {history.length > 0 && (
            <div className="mt-6 p-4 bg-gray-100 rounded border text-sm">
              <h2 className="font-bold mb-2">History (last 5)</h2>
              <ul className="space-y-2">
                {history.map((h, i) => (
                  <li key={i} className="border rounded p-2">
                    <div className="flex justify-between cursor-pointer" onClick={() => toggleExpand(i)}>
                      <span>
                        {h.date} â€“ {h.type === "test" ? <span className="text-gray-500 font-semibold">Test</span> : h.type === "recovery" ? "Recovery Day" : h.level} ({h.totalSU} SU) {h.time ? `â€“ ${h.time}` : ""}
                      </span>
                      <span>{expandedIndex === i ? "â–²" : "â–¼"}</span>
                    </div>

                    {expandedIndex === i && (
                      <div className="mt-2 space-y-2">
                        {h.note && <p className="italic">{h.note}</p>}
                        {h.type !== "recovery" && (
                          <div>
                            <p className="font-semibold">Exercises:</p>
                            <ul className="list-disc list-inside">
                              {h.exercises.map((ex, idx) => (
                                <li key={idx} className={patternColors[ex.pattern] || ""}>
                                  <span>
                                    {ex.name} â€“ {ex.unilateral
                                      ? `${ex.reps} (${Math.ceil((typeof ex.reps === "number" ? ex.reps : parseInt(ex.reps)) / 2)} per arm)`
                                      : ex.reps} {ex.su ? `(${ex.su} SU)` : ""}
                                  </span>
                                  {ex.video && (
                                    <a
                                      className="ml-2 text-xs underline opacity-80"
                                      href={ex.video}
                                      target="_blank"
                                      rel="noopener noreferrer"
                                    >
                                      demo
                                    </a>
                                  )}
                                </li>
                              ))}
                            </ul>
                          </div>
                        )}
                      </div>
                    )}
                  </li>
                ))}
              </ul>

              <div className="text-center mt-3">
                <button onClick={removeLastEntry} className="px-3 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded text-sm mr-2">
                  Remove Last Entry
                </button>
                <button onClick={resetAll} className="px-3 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded text-sm">
                  Clear All History
                </button>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
